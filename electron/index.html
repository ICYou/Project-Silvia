<!DOCTYPE html>
<html>
  <head>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="./src/contents/bootstrap-5.1.3/css/bootstrap.min.css" />
    <link rel="stylesheet" href="./src/contents/bootstrap-5.1.3/css/bootstrap-grid.min.css" />
    <link rel="stylesheet" href="styles.css">
    <!-- <script src="./src/contents/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script> -->

    <!-- Bootstrap Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <!-- <script>require('jquery');</script> -->
    <script>require('popper.js');</script>
    <script>require('bootstrap');</script>


    <!-- <script src="./contents/jquery/3.3.1/jquery-3.3.1.min.js"></script> -->
<!-- <script src="./contents/popper.js/1.14.3/popper.min.js"></script> -->
    <script src="./src/contents/bootstrap-5.1.3/js/bootstrap.min.js"></script>
    <script src="./src/contents/bootstrap-5.1.3/js/bootstrap.bundle.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Silvia</title>
  </head>
  <body>
    <div class="container-fluid">
    <div class="row">
        <div class="col-4">
            <div class="card">
                <div class="card-body">
                  <h4 class="card-title" id="grams"></h4>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                  <h4 class="card-title" id="seconds"></h4>
                </div>
            </div>
            </div>

        <div class="col-4">
            <div class="card">
                <div class="card-body">
                  <h4 class="card-title" id="temp"></h4>
                </div>
            </div>
        </div>
        
        <div class="col-4">
            <div class="card">
            <div class="card-body">
              <input class="btn btn-success btn-round" id="start" type="submit" name="stop" value="start"/>
              <input class="btn btn-warning btn-round" id="stop" type="submit" name="stop" value="stop"/>
              <input class="btn btn-secondary btn-round" id="reset" type="submit" name="reset" value="reset"/>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
              <div>
                <input class="btn btn-primary btn-round" id="tare" type="submit" name="tare-button" value="tare"/>
            </div>
            </div>
        </div>

        </div>
        <div class="col-4">
            <textarea rows="1" cols="20" id="serialJSON"></textarea>

            <br>

            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#serialOutput" aria-expanded="false" aria-controls="serialOutput">
                Show Serial data
            </button>
        </div>

        <div class="col-12 collapse" id="serialOutput">
            <div class="col-12">
                <div>Error and ports:</div>
                <div id="error"></div>
                <div id="ports"></div>
            </div>
            <div class="col-12">
                <div class="card card-body"></div>
                <h1>Serial terminal</h1>
                <textarea rows="30" cols="50" id="incomingData"></textarea>
                </br>
                <textarea rows="1" cols="50" id="inputText"></textarea>
                </br>
                <input class="btn btn-primary" id="button" type="submit" name="button" value="Ctrl+c"/>
            </div>
        </div>
        </div>
    </div>
    </div>
    </div>



    <script>

        //load serialport module
        const { SerialPort } = require('serialport')
        // const Readline = serialPort.parsers.Readline;
        const { ReadlineParser } = require('@serialport/parser-readline')

        //initialize serialport with 9600 baudrate.
        // var sp = new SerialPort('/dev/tty.usbmodem142301', {
        // var sp = new SerialPort({path: '/dev/tty.usbmodem101457901', // MBP
        var sp = new SerialPort({path: '/dev/ttyACM0', //pi
            baudRate: 115200,
            autoOpen: true,
        },function (err) {
            if (err) {
                return console.log('Error: ', err.message)
            }
        });

        if (!sp.isOpen){
            console.log('serial port is closed, attempting to reopen');
            sp.open(function (err) {
            if (err) {
              return console.log('Error opening port: ', err.message)
            }
        })
        }
        
        //parse incoming data line-by-line from serial port.
        // const parser = sp.pipe(new Readline({ delimiter: '\r\n' }));
        const parser = sp.pipe(new ReadlineParser({ delimiter: '\r\n' }));
        parser.on('data', addText);

        sp.on('error', function(err) {
            console.log('Error: ', err.message)
        })

        //append incoming data to the textarea.
        function addText(event) {
            if (event.startsWith("{")){
                document.getElementById("serialJSON").value = event;
                const data = JSON.parse(event);
                console.log(data);
                document.getElementById("grams").innerHTML = data.g + "gram";
                document.getElementById("seconds").innerHTML = data.s + "s";
                document.getElementById("temp").innerHTML = data.t + "\u00B0C";
            }else{
                document.getElementById("incomingData").value += "\n"+event;
            }
        }
    
        function writeonSer(data){
            //Write the data to serial port.
            sp.write( data, function(err) {
                if (err) {
                    return console.log('Error on write: ', err.message);
                }
                console.log('message written');
            });
    
        }
    
        document.getElementById('inputText').onkeypress = function(e){
            if (!e) e = window.event;
            var keyCode = e.keyCode || e.which;
            //write the data to serial when enter key is pressed.
            if (keyCode == '13'){
                //console.log("enter pressed", document.getElementById("inputText").value);
                writeonSer(document.getElementById("inputText").value+"\r\n");
                document.getElementById('inputText').value = "";
                return false;
            }
        }
    
        document.getElementById('button').onclick = function(e){
            //send ctrl+c to serialport
            writeonSer('\x03');
        }
        document.getElementById('tare').onclick = function(e){
            //send ctrl+c to serialport
            writeonSer('t');
        }
        document.getElementById('start').onclick = function(e){
            //send ctrl+c to serialport
            writeonSer('s');
        }
        document.getElementById('stop').onclick = function(e){
            //send ctrl+c to serialport
            writeonSer('p');
        }
        document.getElementById('reset').onclick = function(e){
            //send ctrl+c to serialport
            writeonSer('r');
        }
        
    </script>
    <script>
        // You can also require other files to run in this process
        require('./renderer.js')
    </script>
  </body>
</html>
